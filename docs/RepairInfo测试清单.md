# RepairInfo JSON格式测试清单

## 测试前准备

1. **备份数据库**
   ```bash
   # 备份本地物料库
   copy "ref\LdMainData.db" "ref\LdMainData.db.backup"
   
   # 备份项目数据库（如果有正在使用的项目）
   copy "MyProjects\YourProject\YourProject.db" "MyProjects\YourProject\YourProject.db.backup"
   ```

2. **确认编译成功**
   - 运行 make-release 任务
   - 确认无错误无警告

3. **准备测试数据**
   - 找到一个包含旧格式RepairInfo的元件（如Equipment_ID=10716）

## 测试一：旧格式数据清空

### 目标
验证旧格式数据会被自动清空

### 步骤
1. 打开"本地物料库"
2. 选择 Equipment_ID=10716（三相电机）
3. 切换到"维修信息"tab页

### 预期结果
- ✅ 控制台输出：
  ```
  [TModelHelper::parseRepairInfo] JSON解析失败: illegal value
  [TModelHelper::parseRepairInfo] 检测到旧格式数据，将被清空
  [TModelHelper::parseRepairInfo] 最终解析出0条有效记录
  ```
- ✅ 表格为空

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试二：新增维修信息（基本功能）

### 目标
验证可以添加新的维修信息并正确保存为JSON格式

### 步骤
1. 在空表格中右键 → "新增"
2. 输入以下数据：
   - 故障模式：电机开路
   - 故障概率：0.05
   - 解决方案：更换电机
   - 所需资源：电机×1
3. 再新增一条：
   - 故障模式：轴承损坏
   - 故障概率：0.02
   - 解决方案：更换轴承
   - 所需资源：轴承×1
4. 点击"确定"按钮

### 预期结果
- ✅ 控制台输出：
  ```
  [TModelHelper::saveRepairInfoFromTable] 表格行数: 2
  [TModelHelper::serializeRepairInfo] 序列化2条记录，结果长度:XXX
  Equipment updated successfully
  ```
- ✅ 保存成功

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试三：加载JSON格式数据

### 目标
验证JSON格式数据可以正确加载到表格

### 步骤
1. 关闭"本地物料库"对话框
2. 重新打开"本地物料库"
3. 选择刚才编辑的元件
4. 切换到"维修信息"tab页

### 预期结果
- ✅ 控制台输出：
  ```
  [TModelHelper::parseRepairInfo] 成功解析JSON数组，包含2条记录
  [TModelHelper::loadRepairInfoToTable] 加载行0: 故障模式=电机开路
  [TModelHelper::loadRepairInfoToTable] 加载行1: 故障模式=轴承损坏
  ```
- ✅ 表格显示2条记录，数据正确

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试四：特殊字符处理

### 目标
验证JSON格式可以正确处理特殊字符

### 步骤
1. 编辑第一条记录：
   - 故障模式：轴承|损坏
   - 解决方案：方案：A\B\C
   - 所需资源：资源：X|Y|Z
2. 点击"应用"按钮
3. 切换到其他元件再切换回来

### 预期结果
- ✅ 特殊字符（|、\）正确保存和加载
- ✅ 数据完全一致

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试五：换行符处理

### 目标
验证JSON格式可以正确处理多行文本

### 步骤
1. 编辑解决方案字段，输入多行文本：
   ```
   步骤1：断电检查
   步骤2：更换部件
   步骤3：测试运行
   ```
   提示：在表格单元格中按 Shift+Enter 可输入换行
2. 保存并重新加载

### 预期结果
- ✅ 换行符正确保存
- ✅ 加载后显示多行文本

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试六：空字段处理

### 目标
验证空字段不会导致问题

### 步骤
1. 新增一条记录，只填写故障模式：
   - 故障模式：未知故障
   - 其他字段留空
2. 保存并重新加载

### 预期结果
- ✅ 保存成功
- ✅ 加载后空字段显示为空

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试七：右键菜单功能

### 目标
验证右键菜单的所有功能

### 7.1 新增功能
- [ ] 右键 → "新增" → 表格末尾添加空行
- [ ] 光标自动定位到故障模式列

### 7.2 删除功能
- [ ] 选中单行 → 右键 → "删除" → 直接删除
- [ ] 选中多行 → 右键 → "删除" → 弹出确认框 → 删除成功

### 7.3 从T语言自动获取
- [ ] 在T语言模型中添加故障模式
- [ ] 右键 → "从T语言中自动获取" → 新故障模式添加到表格

### 实际结果
- [ ] 全部通过
- [ ] 失败，原因：___________

---

## 测试八：编译自动获取

### 目标
验证点击编译按钮会自动获取故障模式

### 步骤
1. 在T语言模型中添加新的故障模式
2. 点击"编译"按钮
3. 观察维修信息表格

### 预期结果
- ✅ 编译成功
- ✅ 新故障模式自动添加到表格

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试九：元件属性对话框

### 目标
验证元件属性对话框中的功能与本地物料库一致

### 步骤
1. 打开项目导航器 → 元件tab
2. 右键点击一个元件 → "元件属性"
3. 重复测试二到测试八的所有步骤

### 预期结果
- ✅ 所有功能与本地物料库完全一致

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试十：数据库验证

### 目标
验证数据库中存储的是正确的JSON格式

### 步骤
```bash
# 查看本地物料库
sqlite3 "ref/LdMainData.db" "SELECT Equipment_ID, Name, RepairInfo FROM Equipment WHERE RepairInfo IS NOT NULL AND RepairInfo != '' LIMIT 3;"

# 查看项目数据库
sqlite3 "MyProjects/YourProject/YourProject.db" "SELECT Equipment_ID, DT, RepairInfo FROM Equipment WHERE RepairInfo IS NOT NULL AND RepairInfo != '' LIMIT 3;"
```

### 预期结果
- ✅ RepairInfo字段是有效的JSON字符串
- ✅ 格式类似：`[{"fault":"...","prob":"...","solution":"...","resource":"..."}]`

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 测试十一：更新端口变量功能

### 目标
验证之前实现的"更新端口变量"功能仍然正常

### 步骤
1. 在"端口"tab中配置端口
2. 切换到"T语言模型"tab
3. 点击"更新端口变量"按钮

### 预期结果
- ✅ 端口变量正确生成
- ✅ T语言模型中的端口变量定义已更新

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 性能测试

### 大数据量测试

1. 添加100条维修信息记录
2. 保存并重新加载
3. 观察性能

### 预期结果
- ✅ 保存和加载速度可接受（< 1秒）
- ✅ 界面不卡顿

### 实际结果
- [ ] 通过
- [ ] 失败，原因：___________

---

## 已知问题记录

### 问题1
- **描述**：___________
- **重现步骤**：___________
- **严重程度**：[ ] 严重 [ ] 一般 [ ] 轻微
- **解决方案**：___________

### 问题2
- **描述**：___________
- **重现步骤**：___________
- **严重程度**：[ ] 严重 [ ] 一般 [ ] 轻微
- **解决方案**：___________

---

## 测试总结

### 通过的测试
- [ ] 测试一：旧格式数据清空
- [ ] 测试二：新增维修信息
- [ ] 测试三：加载JSON数据
- [ ] 测试四：特殊字符处理
- [ ] 测试五：换行符处理
- [ ] 测试六：空字段处理
- [ ] 测试七：右键菜单功能
- [ ] 测试八：编译自动获取
- [ ] 测试九：元件属性对话框
- [ ] 测试十：数据库验证
- [ ] 测试十一：更新端口变量功能

### 测试结论
- [ ] 所有测试通过，可以发布
- [ ] 存在问题，需要修复

### 测试人员
- 姓名：___________
- 日期：___________
- 签名：___________

---

## 附录：辅助命令

### 查看数据库表结构
```bash
sqlite3 "ref/LdMainData.db" ".schema Equipment"
```

### 查看所有包含RepairInfo的元件
```bash
sqlite3 "ref/LdMainData.db" "SELECT Equipment_ID, Name, length(RepairInfo) as len FROM Equipment WHERE RepairInfo IS NOT NULL AND RepairInfo != '' ORDER BY len DESC;"
```

### 清空所有RepairInfo（谨慎使用）
```bash
sqlite3 "ref/LdMainData.db" "UPDATE Equipment SET RepairInfo = NULL WHERE RepairInfo IS NOT NULL;"
```

### 验证JSON格式（使用Python）
```bash
python -c "import json,sys; data=sys.argv[1]; print('Valid' if (json.loads(data) or True) else 'Invalid')" "[{\"fault\":\"test\"}]"
```
