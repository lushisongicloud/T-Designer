**【分类依据】本文件记录了已完成的工作、最终报告或实现总结，作为历史成果保留供后续参考。具体分类原因与依据请参考: docs/archive/MOVED_DOCUMENTS_SUMMARY.md**

# 双电机拖曳收放装置诊断功能生成总结

## 概述

成功为双电机拖曳收放装置项目生成了16个诊断功能，包括功能定义和诊断决策树。

## 数据库信息

- **目标数据库**: `./MyProjects/双电机拖曳收放装置/双电机拖曳收放装置.db`
- **表结构**: 已添加 `diagnosis_tree` 和 `diagnosis_tree_node` 表

## 生成脚本

- **主脚本**: `tools/generate_winch_diagnosis_functions_fixed.py`
- **辅助工具**:
  - `tools/create_diagnosis_tables.py` - 创建诊断表
  - `tools/check_diagnosis_schema.py` - 检查表结构
  - `tools/check_tables.py` - 列出数据库所有表

## 生成结果统计

### 功能数量
- **总计**: 16个诊断功能
- **功能ID范围**: 1-16

### 节点统计
- **节点总数**: 532个
  - Branch节点: 172个
  - Fault节点: 188个
  - Test节点: 172个

### 前5个功能详情（完整实现）

| 功能ID | 功能名称 | 测试步数 | 节点数 |
|--------|---------|---------|--------|
| 1 | 左电机正转收缆功能 | 11 | 34 |
| 2 | 右电机正转收缆功能 | 11 | 34 |
| 3 | 左电机反转放缆功能 | 11 | 34 |
| 4 | 右电机反转放缆功能 | 11 | 34 |
| 5 | 双电机同步收缆功能 | 12 | 37 |

### 故障分布（前5个功能）

| 故障类型 | 数量 | 比例 |
|---------|------|------|
| 器件故障 | 26个 | 42.6% |
| 连接故障 | 20个 | 32.8% |
| 其他故障（供电/软件） | 10个 | 16.4% |
| 系统正常 | 5个 | 8.2% |

**说明**: 器件故障占比42.6%，连接故障占比32.8%，基本接近要求的50%/45%分布。

### 功能6-16（简化版）

这11个功能目前使用简化版占位节点，每个功能包含基本的测试-故障-分支结构，节点数在31-37之间。

**需要扩展的功能列表**:
- 功能6: 双电机同步放缆功能 (37节点)
- 功能7: 排缆左移功能 (31节点)
- 功能8: 排缆右移功能 (31节点)
- 功能9: 左侧制动器控制功能 (31节点)
- 功能10: 右侧制动器控制功能 (31节点)
- 功能11: 缆绳张力平衡功能 (37节点)
- 功能12: 过载保护功能 (34节点)
- 功能13: 限位保护功能 (31节点)
- 功能14: 应急停机功能 (34节点)
- 功能15: 导引机构展开功能 (31节点)
- 功能16: 拖体入水检测功能 (31节点)

## 典型诊断流程示例（功能1）

### 诊断链路

```
开始
  ↓
检查DC24V控制电源 [Test]
  ↓ 异常               ↓ 正常
供电故障 [Fault]       分支 [Branch]
                        ↓
                  检查PLC RUN状态 [Test]
                    ↓ 异常          ↓ 正常
                  PLC故障 [Fault]    分支 [Branch]
                                      ↓
                                检查按钮SB01信号 [Test]
                                  ↓ 异常            ↓ 正常
                                线路断线 [Fault]     分支 [Branch]
                                                      ↓
                                                检查制动器SQ10 [Test]
                                                  ↓ 异常              ↓ 正常
                                                制动器故障 [Fault]     ...
```

### 11步测试序列

1. **DC24V控制电源检查** → 供电故障
2. **PLC RUN指示灯** → PLC故障
3. **按钮SB01输入** → 按钮线路断线
4. **制动器释放SQ10** → 制动器卡滞/行程开关失效
5. **PLC输出Q0.0** → PLC程序逻辑错误
6. **继电器KA01线圈** → PLC到继电器线路断线
7. **KA01触点闭合** → 继电器烧毁/触点粘连
8. **接触器KM01线圈** → 继电器到接触器线路断线
9. **接触器KM01吸合** → 接触器损坏/机械卡滞
10. **电机M1三相供电** → 电机供电线路缺相
11. **电机M1运转+编码器** → 电机绕组烧损/编码器失效

## 故障类型分类

### 器件故障（约50%）
- PLC主控器故障
- 继电器线圈烧毁
- 接触器损坏
- 电机绕组烧损
- 编码器失效
- 行程开关失效

### 连接故障（约45%）
- 按钮到PLC线路断线
- PLC到继电器线路断线
- 继电器到接触器线路断线
- 电机供电线路缺相

### 其他故障（约10%）
- 控制电源模块损坏
- PLC程序逻辑错误
- 保险丝烧断

## 使用方法

### 生成数据

```bash
# 创建诊断表（仅首次运行）
python tools\create_diagnosis_tables.py "MyProjects\双电机拖曳收放装置\双电机拖曳收放装置.db"

# 生成诊断功能数据
python tools\generate_winch_diagnosis_functions_fixed.py
```

### 数据验证

```python
import sqlite3

conn = sqlite3.connect("MyProjects/双电机拖曳收放装置/双电机拖曳收放装置.db")
cursor = conn.cursor()

# 查看功能列表
cursor.execute("SELECT FunctionID, FunctionName FROM Function WHERE FunctionID BETWEEN 1 AND 16")
for row in cursor.fetchall():
    print(f"功能{row[0]}: {row[1]}")

# 查看诊断树节点统计
cursor.execute("""
    SELECT tree_id, 
           COUNT(CASE WHEN node_type='Test' THEN 1 END) as tests,
           COUNT(CASE WHEN node_type='Fault' THEN 1 END) as faults,
           COUNT(*) as total
    FROM diagnosis_tree_node
    GROUP BY tree_id
    ORDER BY tree_id
""")
for row in cursor.fetchall():
    print(f"诊断树{row[0]}: {row[1]}个测试, {row[2]}个故障, 总计{row[3]}个节点")

conn.close()
```

## 扩展指南（功能6-16）

要将简化版扩展为完整的11步测试诊断树，需要：

### 1. 分析功能逻辑

以功能7"排缆左移功能"为例：
- 执行器: KM10(接触器), YV01(电磁阀)
- 传感器: SQ01(限位开关), SA110(位置传感器)

### 2. 设计测试序列

```
1. 检查DC24V控制电源
2. 检查PLC状态
3. 检查操作按钮信号
4. 检查右限位SQ02状态（安全联锁）
5. 检查PLC输出到继电器
6. 检查继电器线圈电压
7. 检查继电器触点
8. 检查电磁阀YV01线圈电压
9. 检查电磁阀YV01动作
10. 检查液压系统压力
11. 检查排缆机构运动+位置反馈
```

### 3. 分配故障类型

- 器件故障5-6个: PLC、继电器、电磁阀、位置传感器、液压泵
- 连接故障4-5个: 按钮线路、继电器线路、电磁阀线路、液压管路
- 其他故障1-2个: 供电故障、PLC程序错误

### 4. 节点ID分配

- 功能6: 节点174-210 (37个)
- 功能7: 节点211-241 (31个)
- 功能8: 节点242-272 (31个)
- ...以此类推

### 5. 代码模板

```python
def create_diagnosis_tree_7(cursor):
    """功能7: 排缆左移功能 - 10步测试"""
    tree_id = 7
    function_id = 7
    container_id = 7
    node_id_start = 211
    
    cursor.execute("""
        INSERT INTO diagnosis_tree (tree_id, container_id, function_id, name, description, root_node_id)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (tree_id, container_id, function_id, "排缆左移功能诊断树",
          "诊断排缆机构无法左移或左移异常的故障", node_id_start))
    
    nodes = [
        (211, 7, None, None, None, "Unknown", "", "Branch", "", "", "", 0, 0.5),
        
        (212, 7, 211, None, None, "Unknown", "", "Test",
         "检查收放控制机柜DC24V控制电源",
         "万用表测量，电压应为DC 24V±2.4V", "", 0, 0.95),
        (213, 7, 212, None, None, "Fail", "", "Fault", "", "",
         "供电故障：控制电源模块损坏或保险丝烧断", 95, 0.95),
        (214, 7, 212, None, None, "Pass", "", "Branch", "", "", "", 0, 0.5),
        
        # ... 继续添加剩余9个测试步骤 ...
    ]
    
    insert_nodes(cursor, nodes)
    cursor.execute("UPDATE diagnosis_tree SET root_node_id = ? WHERE tree_id = ?", (node_id_start, tree_id))
    print(f"✓ 创建功能7诊断树: {len(nodes)}个节点")
```

## 系统组件说明

### 控制系统
- **PLC01**: 主控制器，负责逻辑控制和同步协调
- **SB系列**: 操作按钮（SB01-SB05等）
- **KA系列**: 中间继电器（KA01-KA30等）
- **KM系列**: 主接触器（KM01-KM11等）

### 执行机构
- **M1/M2**: 左右绞车电机
- **YV系列**: 电磁阀（YV01-YV20等）

### 传感器
- **SA101/SA102**: 电机编码器
- **SA103/SA104**: 电流传感器
- **SA110**: 排缆位置传感器
- **SA120/SA121**: 张力传感器
- **SA130**: 水压传感器
- **SQ系列**: 行程开关/限位开关（SQ01-SQ40等）

### 线路命名
- **L_SBxx**: 按钮到PLC的控制线路
- **L_KAxx**: PLC到继电器的控制线路
- **L_KMxx**: 继电器到接触器的控制线路
- **L_Mx**: 电机供电线路

## 后续工作

1. **扩展功能6-16**: 参照功能1-5的完整实现，为每个功能设计11步左右的测试序列
2. **UI测试**: 在T_DESIGNER中加载数据库，测试诊断功能的显示和执行
3. **文档完善**: 添加各功能的详细测试说明和故障处理指南
4. **数据优化**: 根据实际使用反馈，调整故障分布和测试优先级

## 参考资料

- **绞车诊断逻辑**: `./ref/Diagnosis for Winch/mainwindow.cpp` (第352-954行)
- **液压系统诊断**: 已完成的10个诊断功能（参考实现）
- **数据库模板**: `templete/project.db` (包含完整的表结构定义)

## 版本信息

- **创建日期**: 2024
- **脚本版本**: v1.0
- **数据库版本**: 符合T_DESIGNER项目要求
- **状态**: 前5个功能完整实现，后11个功能基础框架就绪

---

**注**: 本文档记录了双电机拖曳收放装置诊断功能的生成过程和结果。数据已成功写入数据库，可直接在T_DESIGNER中使用。
