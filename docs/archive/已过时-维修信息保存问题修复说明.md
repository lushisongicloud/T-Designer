**【分类依据】本文件记录了具体的修复过程、调试分析或已过时的设计实现，作为问题解决的临时记录保留。具体分类原因与依据请参考: docs/archive/MOVED_DOCUMENTS_SUMMARY.md**

# 维修信息保存问题修复说明

## 问题描述
点击"确定"或"应用"按钮后，维修信息表格中的数据会丢失，再次打开对话框时表格变为空白。

## 问题原因
在 `dialogunitmanage.cpp` 中，`on_BtnOK_clicked()` 函数没有调用保存逻辑就直接关闭了对话框，导致用户编辑的维修信息未能保存到数据库。

## 修复内容

### 1. 修改 dialogunitmanage.cpp
在 `on_BtnOK_clicked()` 函数开头添加对 `on_BtnApply_clicked()` 的调用：

```cpp
void DialogUnitManage::on_BtnOK_clicked()
{
    // 先调用保存逻辑
    on_BtnApply_clicked();
    
    Canceled=false;
    if(ui->tableWidgetSpur->currentRow()>=0) EquipmentTemplate_ID=ui->tableWidgetSpur->item(ui->tableWidgetSpur->currentRow(),1)->data(Qt::UserRole).toInt();
    else EquipmentTemplate_ID=0;
    RetCode=1;
    close();
}
```

### 2. 添加调试输出
在 `TModelHelper::saveRepairInfoFromTable()` 和 `TModelHelper::loadRepairInfoToTable()` 中添加了详细的调试输出，方便追踪数据流：

- 显示表格行数
- 显示每行的数据内容
- 显示序列化结果
- 显示解析结果

## 测试步骤

### 测试一：本地物料库（dialogunitmanage）

1. **打开本地物料库**
   - 主界面 → 导航栏 → "数据管理" → "本地物料库"
   - 窗口标题应为"数据库管理"

2. **选择测试元件**
   - 在左侧树形列表中选择一个元件（建议选择"三相电机"，Equipment_ID=10716）
   - 切换到"维修信息"tab页

3. **编辑维修信息**
   - 右键点击表格 → "新增"
   - 输入以下测试数据：
     * 故障模式：电机绕组开路
     * 故障概率：0.05
     * 解决方案：更换电机
     * 所需资源：电机×1
   - 再添加一条：
     * 故障模式：轴承损坏
     * 故障概率：0.02
     * 解决方案：更换轴承
     * 所需资源：轴承×1

4. **保存数据（测试"确定"按钮）**
   - 点击"确定"按钮
   - 观察控制台输出的调试信息：
     ```
     [TModelHelper::saveRepairInfoFromTable] 表格行数: 2
     [TModelHelper::saveRepairInfoFromTable] 行0: 故障模式=电机绕组开路, 概率=0.05, 方案=更换电机, 资源=电机×1
     [TModelHelper::saveRepairInfoFromTable] 行1: 故障模式=轴承损坏, 概率=0.02, 方案=更换轴承, 资源=轴承×1
     [TModelHelper::saveRepairInfoFromTable] 序列化结果长度: XX
     [TModelHelper::saveRepairInfoFromTable] 序列化结果: 电机绕组开路￤0.05￤更换电机￤电机×1￤￤轴承损坏￤0.02￤更换轴承￤轴承×1
     Equipment updated successfully for Equipment_ID: 10716
     ```

5. **验证数据持久化**
   - 重新打开"本地物料库"
   - 选择相同的元件
   - 切换到"维修信息"tab页
   - 观察控制台输出：
     ```
     [TModelHelper::loadRepairInfoToTable] RepairInfo长度: XX
     [TModelHelper::loadRepairInfoToTable] RepairInfo内容: 电机绕组开路￤0.05￤更换电机￤电机×1￤￤轴承损坏￤0.02￤更换轴承￤轴承×1
     [TModelHelper::loadRepairInfoToTable] 解析出2条故障记录
     [TModelHelper::loadRepairInfoToTable] 加载行0: 故障模式=电机绕组开路
     [TModelHelper::loadRepairInfoToTable] 加载行1: 故障模式=轴承损坏
     ```
   - **验证点**：表格中应显示刚才输入的两条记录

6. **测试"应用"按钮**
   - 修改第一条记录的故障概率为 0.08
   - 点击"应用"按钮（不要关闭窗口）
   - 观察控制台输出
   - 切换到其他元件，再切换回来
   - **验证点**：故障概率应为 0.08

### 测试二：元件属性（dialogUnitAttr）

1. **打开元件属性**
   - 主界面 → 项目导航器 → "元件"tab页
   - 在实体元件树中右键点击一个元件
   - 选择"元件属性"
   - 窗口标题应为"元件属性"

2. **编辑维修信息**
   - 切换到"维修信息"tab页
   - 右键点击表格 → "新增"
   - 输入测试数据（参考上面的数据）

3. **保存并验证**
   - 点击"确定"按钮
   - 观察控制台调试输出
   - 重新打开该元件的属性
   - **验证点**：维修信息应正确显示

### 测试三：数据库验证

使用sqlite3命令行工具直接查看数据库：

```powershell
# 查看本地物料库
sqlite3 "ref/LdMainData.db" "SELECT Equipment_ID, Name, RepairInfo FROM Equipment WHERE Equipment_ID=10716;"

# 查看项目数据库（替换为实际项目路径）
sqlite3 "MyProjects/DemoSystem/DemoSystem.db" "SELECT Equipment_ID, DT, RepairInfo FROM Equipment WHERE RepairInfo IS NOT NULL AND RepairInfo != '' LIMIT 5;"
```

**验证点**：RepairInfo字段应包含正确格式的数据：
```
故障模式￤故障概率￤解决方案￤所需资源￤￤故障模式￤故障概率￤...
```

### 测试四：右键菜单功能

1. **测试"删除"功能**
   - 选中一行或多行（按Ctrl键多选）
   - 右键 → "删除"
   - 如果选中多行，应弹出确认对话框
   - 点击"确定"保存
   - 重新打开，验证删除成功

2. **测试"从T语言中自动获取"功能**
   - 切换到"T语言模型"tab页
   - 在T语言编辑器中添加故障模式：
     ```
     ;;故障模式名测试故障1
     (assert ...)
     
     ;;故障模式名测试故障2
     (assert ...)
     ```
   - 切换回"维修信息"tab页
   - 右键 → "从T语言中自动获取"
   - **验证点**：应添加"测试故障1"和"测试故障2"两条记录

3. **测试编译自动获取**
   - 在T语言模型中再添加一个故障模式
   - 点击"编译"按钮
   - **验证点**：编译完成后，维修信息表格应自动添加新故障模式

## 调试输出说明

修复后的代码会在控制台输出详细的调试信息，帮助追踪数据流：

### 保存时的输出
```
[TModelHelper::saveRepairInfoFromTable] 表格行数: N
[TModelHelper::saveRepairInfoFromTable] 行X: 故障模式=XXX, 概率=YYY, 方案=ZZZ, 资源=WWW
[TModelHelper::saveRepairInfoFromTable] 序列化结果长度: NN
[TModelHelper::saveRepairInfoFromTable] 序列化结果: ...
Equipment updated successfully for Equipment_ID: XXXX
```

### 加载时的输出
```
[TModelHelper::loadRepairInfoToTable] RepairInfo长度: NN
[TModelHelper::loadRepairInfoToTable] RepairInfo内容: ...
[TModelHelper::loadRepairInfoToTable] 解析出N条故障记录
[TModelHelper::loadRepairInfoToTable] 加载行X: 故障模式=XXX
```

## 已知问题

### 问题1：旧数据格式兼容性
数据库中可能存在旧格式的RepairInfo数据（结尾带`￤￤`），`parseRepairInfo` 函数使用 `QString::SkipEmptyParts` 应该能正确处理，但仍需验证。

**测试方法**：
1. 打开包含旧数据的元件（如三相电机，Equipment_ID=10716）
2. 观察控制台输出的解析结果
3. 验证表格是否正确显示所有故障模式

### 问题2：QMap的顺序
`QMap` 会按key排序，可能导致故障模式的显示顺序与输入顺序不同。如果需要保持输入顺序，应改用 `QVector<QPair<QString, QStringList>>`。

**影响评估**：轻微，仅影响显示顺序，不影响功能。

## 后续建议

1. **移除调试输出**：测试验证无误后，可以将 `qDebug()` 语句移除或改为条件编译
2. **添加错误处理**：在SQL执行失败时显示友好的错误提示
3. **数据验证**：在保存前验证故障概率是否为有效数值（0-1之间）
4. **批量操作**：考虑添加批量导入/导出功能

## 回归测试检查清单

- [ ] 本地物料库：新增维修信息
- [ ] 本地物料库：编辑维修信息
- [ ] 本地物料库：删除维修信息
- [ ] 本地物料库：点击"确定"保存
- [ ] 本地物料库：点击"应用"保存
- [ ] 元件属性：新增维修信息
- [ ] 元件属性：编辑维修信息
- [ ] 元件属性：删除维修信息
- [ ] 元件属性：点击"确定"保存
- [ ] 右键菜单：从T语言自动获取
- [ ] 编译按钮：自动获取故障模式
- [ ] 数据持久化：关闭重开验证
- [ ] 旧数据兼容：打开包含旧格式数据的元件
- [ ] 更新端口变量功能正常
- [ ] T语言编译功能正常

## 相关文件

- `dialogunitmanage.cpp` - 本地物料库对话框（已修复）
- `dialogUnitAttr.cpp` - 元件属性对话框（已正确实现）
- `BO/function/tmodelhelper.cpp` - 维修信息处理工具类（已添加调试输出）
- `tools/test_repairinfo_format.py` - 数据格式测试脚本
- `docs/T语言端口变量更新与维修信息管理功能说明.md` - 功能说明文档
