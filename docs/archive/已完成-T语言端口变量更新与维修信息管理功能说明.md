**【分类依据】本文件记录了已完成的工作、最终报告或实现总结，作为历史成果保留供后续参考。具体分类原因与依据请参考: docs/archive/MOVED_DOCUMENTS_SUMMARY.md**

# T语言模型端口变量更新与维修信息管理功能

## 功能概述

本次更新为"本地物料库"（dialogunitmanage）和"元件属性"（dialogUnitAttr）对话框添加了以下功能：

1. **更新端口变量按钮**：根据端口配置自动生成SMT端口变量声明
2. **维修信息表格重构**：调整列顺序，将"故障模式"作为第一列，"故障概率"作为第二列
3. **维修信息右键菜单**：新增、删除、从T语言自动获取故障模式
4. **编译自动同步**：编译时自动从T语言模型提取故障模式

## 1. 更新端口变量功能

### 位置
- **本地物料库**：T语言模型 tab → "更新端口变量"按钮（位于"校验"按钮左侧）
- **元件属性**：T语言模型 tab → "更新端口变量"按钮（位于"校验"按钮左侧）

### 功能说明
点击"更新端口变量"按钮后：
1. 读取"端口"tab中的端口配置信息（tableTerm表格）
2. 根据端口信息自动生成SMT-LIB2格式的变量声明
3. 清除T语言编辑器中原有的`;;端口变量定义`区域内容
4. 插入新生成的端口变量声明

### 生成规则
- 变量名格式：`%Name%.子块代号.端号.变量名`
- 示例：`(declare-fun %Name%.Coil.A1.i () Real)`
- 支持多个变量（逗号或分号分隔）
- 自动去重，避免重复声明

### 使用场景
- 修改端口配置后，需要同步更新T语言模型中的端口变量声明
- 初次创建T语言模型时，快速生成端口变量定义

## 2. 维修信息表格重构

### 数据格式变更

#### 旧格式
列顺序：名称 | 故障模式 | 解决方案 | 所需资源

#### 新格式
列顺序：**故障模式** | **故障概率** | 解决方案 | 所需资源

### 数据库存储格式
- 字段名：`RepairInfo`（VARCHAR）
- 格式：`故障模式￤故障概率￤解决方案￤所需资源￤￤故障模式￤...`
- 记录分隔符：`￤￤`（双全角方框）
- 字段分隔符：`￤`（单全角方框）

### 列宽设置
- 故障模式：200px
- 故障概率：100px
- 解决方案：240-300px
- 所需资源：140-240px

## 3. 维修信息右键菜单

### 位置
在维修信息表格（tableRepairInfo）中右键点击

### 菜单项

#### 3.1 新增
- **功能**：在表格末尾添加一行空白记录
- **操作**：自动选中新行的第一列（故障模式），进入编辑模式

#### 3.2 删除
- **功能**：删除选中的一行或多行
- **支持多选**：按Ctrl或Shift键可选择多行
- **二次确认**：删除多于1行时，弹出确认对话框
  - 提示信息：`确定要删除选中的 N 行吗？`
  - 按钮：Yes | No

#### 3.3 从T语言中自动获取
- **功能**：解析T语言模型，提取故障模式名称，补充到表格中
- **规则**：
  - 只添加表格中不存在的故障模式
  - 新添加的记录：故障模式已填写，其他列为空
  - T语言模型为空时，提示"T语言模型为空"
  - 成功后提示：`已添加 N 个故障模式`
  - 无新增时提示：`没有新的故障模式需要添加`

### T语言故障模式识别规则
解析器识别以下标记：
- `;;故障模式名xxx`：任何以`;;`开头且不是固定关键字的行都被视为故障模式名
- 支持的故障模式名示例：
  - `;;故障模式名a`
  - `;;broken`
  - `;;电阻开路`
  - `;;断路`
  - `;;37号模块故障`

## 4. 编译按钮自动同步

### 功能增强
点击"编译"按钮时，除了原有的编译和显示功能外，还会：
1. 自动执行"从T语言中自动获取"
2. 静默添加新故障模式（不弹窗提示）
3. 在控制台输出：`自动添加了 N 个故障模式`

### 使用场景
- 编写或修改T语言模型后，点击编译即可自动同步故障模式列表
- 减少手动操作，确保维修信息与T语言模型一致

## 5. 代码复用设计

### TModelHelper工具类
为避免在两处对话框中重复维护相同逻辑，创建了`TModelHelper`工具类（`BO/function/tmodelhelper.h/cpp`）

#### 主要方法

```cpp
// 从端口表格生成SMT端口变量声明
QString generatePortVariablesFromTable(QTableWidget *tableTerm, const QString &componentName);

// 从T语言模型提取故障模式列表
QStringList extractFaultModesFromTModel(const QString &tmodelText);

// 更新T语言模型中的端口变量定义部分
QString updatePortVariablesInTModel(const QString &tmodelText, const QString &newPortVariables);

// 解析RepairInfo字段为故障映射
QMap<QString, QStringList> parseRepairInfo(const QString &repairInfoStr);

// 序列化故障映射为RepairInfo字段
QString serializeRepairInfo(const QMap<QString, QStringList> &faultMap);

// 加载RepairInfo到表格
void loadRepairInfoToTable(QTableWidget *tableRepairInfo, const QString &repairInfoStr);

// 从表格保存RepairInfo
QString saveRepairInfoFromTable(QTableWidget *tableRepairInfo);

// 从T语言模型自动填充故障模式到表格
int autoFillFaultModesFromTModel(QTableWidget *tableRepairInfo, const QString &tmodelText);
```

### 共享逻辑
以下功能在两处对话框中完全复用：
- ✅ 端口变量生成算法
- ✅ T语言解析器（TModelParser）
- ✅ 故障模式提取逻辑
- ✅ RepairInfo数据格式转换
- ✅ 表格加载/保存逻辑
- ✅ 右键菜单操作逻辑

## 6. 修改文件清单

### 新增文件
- `BO/function/tmodelhelper.h` - 工具类头文件
- `BO/function/tmodelhelper.cpp` - 工具类实现

### 修改文件
- `T_DESIGNER.pro` - 添加新源文件
- `dialogunitmanage.ui` - UI修改（按钮、列名）
- `dialogunitmanage.h` - 添加槽函数声明
- `dialogunitmanage.cpp` - 实现新功能
- `dialogUnitAttr.ui` - UI修改（按钮、列名）
- `dialogUnitAttr.h` - 添加槽函数声明
- `dialogUnitAttr.cpp` - 实现新功能
- `BO/function/tmodelparser.cpp` - 修复公共块解析bug

## 7. 测试建议

### 7.1 更新端口变量测试
1. 在"端口"tab中添加/修改端口配置
2. 切换到"T语言模型"tab
3. 点击"更新端口变量"按钮
4. 验证：
   - `;;端口变量定义`区域内容已更新
   - 变量名格式正确
   - 没有重复声明

### 7.2 维修信息右键菜单测试
1. **新增功能**：
   - 右键点击表格 → 新增
   - 验证：新行已添加，光标在第一列

2. **删除功能**：
   - 选中单行 → 右键删除 → 验证直接删除
   - 选中多行 → 右键删除 → 验证弹出确认框 → 点击Yes → 验证已删除

3. **自动获取功能**：
   - 在T语言编辑器中添加故障模式（如`;;故障模式名测试`）
   - 右键点击表格 → 从T语言中自动获取
   - 验证：新故障模式已添加到表格

### 7.3 编译自动同步测试
1. 在T语言编辑器中添加新故障模式
2. 点击"编译"按钮
3. 验证：
   - 编译对话框正常显示
   - 维修信息表格自动添加了新故障模式
   - 控制台输出添加数量

### 7.4 数据持久化测试
1. 添加/修改维修信息
2. 点击"应用"或"确定"按钮保存
3. 关闭对话框重新打开
4. 验证：维修信息正确加载

### 7.5 跨对话框一致性测试
1. 在"本地物料库"中测试所有功能
2. 在"元件属性"中测试所有功能
3. 验证：两处行为完全一致

## 8. 注意事项

### 8.1 数据兼容性
- RepairInfo字段格式已变更，旧数据需要迁移
- 第一列从"名称"改为"故障模式"
- 第二列从"故障模式"改为"故障概率"
- 建议：使用前备份数据库

### 8.2 端口配置要求
- 端口表格必须包含：子块代号、端号、变量列
- 变量列支持多个变量（逗号或分号分隔）
- 空行或不完整数据会被跳过

### 8.3 T语言格式要求
- 故障模式名标记必须以`;;`开头
- 固定关键字不被识别为故障模式名：
  - `;;端口变量定义`
  - `;;内部变量定义`
  - `;;正常模式`
  - `;;故障模式`
  - `;;公共开始`
  - `;;公共结束`

## 9. 已知问题与限制

### 9.1 端口变量更新
- 仅替换`;;端口变量定义`区域，不影响其他部分
- 如果T语言模型中没有该标记，会在文件开头添加
- 手动编写的端口变量会被完全替换

### 9.2 故障模式提取
- 仅提取故障模式名称，不提取约束内容
- 依赖TModelParser的解析能力
- 如果T语言语法错误，可能无法正确提取

### 9.3 表格操作
- 删除操作不可撤销
- 批量删除时按行号降序删除（避免索引变化）
- 表格编辑后需手动保存（点击"应用"或"确定"）

## 10. 未来改进方向

1. **故障概率验证**：限制输入范围（0-1）
2. **故障模式模板**：提供常见故障模式快速插入
3. **导入导出**：支持Excel格式导入导出维修信息
4. **历史记录**：记录维修信息变更历史
5. **批量编辑**：支持批量设置故障概率
6. **智能提示**：根据元件类型推荐常见故障模式

## 11. 相关文档

- [T语言模型解析器实现](./T语言模型功能实现总结.md)
- [T语言模型数据库设计方案](./T语言模型数据库设计方案.md)
- [端口配置管理说明](../AGENTS.md)
