**【分类依据】本文件记录了已完成的工作、最终报告或实现总结，作为历史成果保留供后续参考。具体分类原因与依据请参考: docs/archive/MOVED_DOCUMENTS_SUMMARY.md**

# 批量自动编写功能重构方案

## 目标

### 批量自动编写模式
- ✅ 纯数据库驱动，不操作 DialogUnitManage 的任何 UI
- ✅ 支持多线程（初期测试使用1个线程）
- ✅ 两阶段处理：
  1. 获取器件清单（Equipment_ID, PartCode, Name）
  2. 与 log 文件对比，跳过已处理器件
  3. 多线程处理未完成器件
- ✅ 每个线程对应一个 Tab 页显示进度
- ✅ Log 文件仅记录 `[RESULT]` 行，不记录中间过程
- ✅ 中间过程（AI输入输出）显示在对应 Tab 的对话框中
- ✅ 对话框内容过多时自动清理

### 单器件自动编写模式  
- ✅ 从 DialogUnitManage 的 tableTerm 控件获取端口信息
- ✅ 更新端口配置和 T 语言模型后存入数据库
- ✅ 刷新 UI（调用 `on_tableWidgetUnit_clicked`）

## 架构设计

### 类结构

```
BatchAutoGenerateDialog (UI对话框)
  ├─ QTabWidget (多个Tab页，每个线程一个)
  ├─ 总进度显示
  └─ 日志文件路径显示

BatchAutoGenerateManager (批量管理器)
  ├─ 负责读取器件清单
  ├─ 解析 log 文件，标记已完成器件
  ├─ 创建和管理工作线程
  └─ 汇总结果到 log 文件

SingleEquipmentWorker (单个器件处理线程)
  ├─ 从数据库加载器件信息、端口列表、端口配置
  ├─ 调用 DeepSeek API
  ├─ 保存结果到数据库
  └─ 发送信号更新 UI

TModelAutoGenerator (重构后)
  ├─ 单器件模式：从 UI 获取端口，操作 UI
  └─ 不再用于批量模式
```

### 数据流

#### 批量模式
```
BatchAutoGenerateDialog::startRequested
  ↓
BatchAutoGenerateManager::start()
  ↓
1. 查询器件清单：SELECT Equipment_ID, PartCode, Name FROM Equipment
  ↓
2. 解析 log 文件，标记已完成：parseLogFile()
  ↓
3. 创建工作线程：createWorker(equipmentId)
  ↓
SingleEquipmentWorker::run()
  ├─ loadEquipmentInfo()       // Equipment 表
  ├─ loadPortList()             // EquipmentTemplate 表
  ├─ loadPortConfigs()          // port_config 表
  ├─ callDeepSeekAPI()          // 端口类型识别 + 模型生成
  ├─ saveResults()              // 保存到数据库
  └─ emit finished(result)
  ↓
BatchAutoGenerateManager::onWorkerFinished()
  ↓
appendToLogFile("[RESULT] equipmentId|code|status|message")
```

#### 单器件模式
```
DialogUnitManage::on_BtnAutoGenerate_clicked()
  ↓
collectPortsFromTableTerm()  // 从 UI 获取端口
  ↓
TModelAutoGenerator::startAutoGeneration()
  ├─ setPreloadedPorts(ports)
  ├─ setBatchMode(false)
  ├─ setSelectedEquipmentId(equipmentId)
  └─ 处理流程（保持现有逻辑）
  ↓
保存到数据库后刷新 UI：
  on_tableWidgetUnit_clicked()
```

## 实现步骤

### 阶段1：创建新的批量处理类（本次实现）

1. ✅ 创建 `SingleEquipmentWorker` 类（QThread）
   - 从数据库加载所有信息
   - 调用 DeepSeek API
   - 保存结果
   - 不操作任何 UI

2. ✅ 创建 `BatchAutoGenerateManager` 类
   - 管理器件队列
   - 创建和管理工作线程
   - 处理 log 文件

3. ✅ 修改 `BatchAutoGenerateDialog`
   - 添加 QTabWidget 支持多线程显示
   - 简化日志记录（仅 RESULT）

### 阶段2：重构现有代码

1. ⏳ 简化 `TModelAutoGenerator`
   - 移除批量模式相关逻辑
   - 专注于单器件 + UI 交互

2. ⏳ 修改 `DialogUnitManage`
   - 批量模式使用新的 `BatchAutoGenerateManager`
   - 单器件模式继续使用 `TModelAutoGenerator`

### 阶段3：测试与优化

1. ⏳ 单线程测试
2. ⏳ 多线程测试
3. ⏳ Log 文件恢复功能测试

## Log 文件格式

```
[START] 2025-11-09 14:00:00 | Total: 150
[RESULT] 123|PXC.2700784|success|生成完成
[RESULT] 124|A-B.1756-IA16I|failed|端口信息不完整
[RESULT] 125|KA1|success|生成完成
[END] 2025-11-09 14:30:00 | Success: 148, Failed: 2
```

## 关键技术点

1. **线程安全**：数据库连接在每个线程独立创建
2. **UI更新**：通过信号槽从工作线程更新 UI
3. **资源管理**：线程完成后自动清理
4. **错误处理**：捕获所有异常，记录到 log

## 文件清单

### 新增文件
- `BO/batch/singleequipmentworker.h/.cpp` - 单器件处理线程
- `BO/batch/batchautogeneratemanager.h/.cpp` - 批量管理器

### 修改文件  
- `widget/batchautogeneratedialog.h/.cpp` - 增加 Tab 支持
- `dialogunitmanage.cpp` - 切换到新的批量处理逻辑
- `BO/ai/tmodelautogenerator.h/.cpp` - 移除批量模式逻辑

### 配置文件
- `T_DESIGNER.pro` - 添加新文件到构建系统

---

**当前状态**：规划阶段  
**下一步**：创建 `SingleEquipmentWorker` 类的基本框架
