# 测试性建模与交互式故障诊断一体化软件设计说明

## 1. 引言

本软件设计说明旨在全面阐述“测试性建模与交互式故障诊断一体化集成开发环境软件”（以下简称T-Designer）的架构设计、功能实现逻辑及关键技术细节。本软件的设计初衷是为解决舰船装备总体及复杂机电液系统在全寿命周期内的测试性设计与评估难题，通过构建可视化的建模环境与高效的推理引擎，实现从原理图建模到故障诊断方案生成的全流程支持。本设计文档依据项目总体方案要求，结合现有C++代码库（基于Qt框架）的实现现状，重点描述了基于多信号流图（MSFG）的建模机制、依赖矩阵（D-Matrix）生成的数学原理以及基于Z3求解器的逻辑优化策略，确保软件能够满足测试大纲中关于大规模节点（不小于10000个）处理能力及亚秒级交互响应的性能指标。

## 2. 系统总体架构设计

T-Designer采用了典型的分层架构模式，遵循关注点分离原则，将系统划分为用户交互层（Presentation Layer）、业务逻辑层（Business Logic Layer）、数据持久层（Data Persistence Layer）以及基础设施层（Infrastructure Layer）。这种架构设计不仅保证了系统的模块化与可维护性，也为后续集成AI辅助功能（如DeepSeek接口）提供了灵活的扩展空间。

用户交互层主要基于Qt Graphics View框架构建，承担着可视化建模的核心职能。该层通过`BQGraphicsView`和`BQGraphicsScene`类实现了对复杂装备原理图的渲染与交互操作，支持网格吸附、多层级缩放及自定义图元绘制。业务逻辑层是系统的核心，分为`BO`（Business Objects）与`DO`（Data Objects）两个命名空间，前者负责运行时对象的行为控制与算法调度，涵盖了`DiagnosisEngine`（诊断引擎）、`TestGenerator`（测试生成器）等核心组件；后者则专注于数据的内存模型定义，如`ComponentEntity`、`SystemEntity`等，确保了业务运算与界面渲染的数据解耦。

数据持久层采用SQLite嵌入式数据库作为主要的存储引擎，通过`SqliteDatabase`类封装了对`.db`文件的读写操作，支持工程文件（.swPro）、模型数据及参数配置的事务性存储。基础设施层则集成了第三方核心库，包括用于逻辑约束求解的Z3 Solver以及用于图论计算的基础算法库，为上层的可达性分析与依赖矩阵生成提供底层算力支持。

![系统总体架构图]
*(图1：系统总体架构图，展示用户交互层、业务逻辑层、数据持久层及基础设施层的依赖关系及数据流向)*

## 3. 详细功能模块设计

### 3.1 可视化建模子系统

可视化建模子系统是用户进行测试性设计的基础平台，其设计核心在于实现“图-模”一体化。在代码实现上，`BQGraphicsItem`及其派生类（如`BPointItem`）构成了画布上的基本图元，分别代表系统中的组件、端口及连接关系。系统采用事件驱动机制处理用户的绘图操作，当用户在画布上放置组件或连线时，`SystemStructureService`会实时更新内存中的拓扑结构，确保图形数据与逻辑数据的一致性。为了支持大规模系统的建模，设计中引入了图层管理与懒加载机制，仅在视口范围内渲染必要的图元，从而保证了在处理万级节点时的流畅度。此外，该子系统通过`ComponentEntity`类维护组件的属性信息（如故障率、测试成本等），并通过信号槽机制实现了属性编辑器（`DialogAttrDefSet`）与图元对象的双向绑定，满足了测试大纲中关于“所见即所得”的建模要求。

### 3.2 测试性分析与D矩阵生成模块

测试性分析模块的核心任务是将物理连接模型转化为用于诊断推理的数学模型，即依赖矩阵（D-Matrix）。该模块主要由`DMatrixService`与`DependencyResolver`类实现。在生成D矩阵的过程中，系统首先遍历全局的拓扑结构，利用深度优先搜索（DFS）或广度优先搜索（BFS）算法，结合Z3求解器（`Z3Simplifier`）进行信号流的可达性分析。Z3求解器的引入是本设计的关键技术点，它能够处理复杂的逻辑约束（如开关状态、流向限制），有效剔除物理连接中逻辑不可达的路径，从而生成精确的故障-测试相关性矩阵。生成的D矩阵以二维数组形式存储，行代表测试项目，列代表故障模式，矩阵元素$d_{ij}$表示第$i$个测试能否检测出第$j$个故障。为了优化性能，大纲要求的“测试性分析时间小于10秒”是通过并行计算与矩阵稀疏化存储技术来实现的，系统会自动识别并合并等价故障类，显著降低了矩阵的维度。

### 3.3 交互式诊断推理引擎

交互式诊断推理引擎旨在指导维修人员通过最少的测试步骤定位故障，其核心在于动态测试序列的生成。`DiagnosisEngine`类是该模块的中枢，它依据当前的D矩阵状态与已知的测试结果（通过/不通过），动态计算剩余候选测试集的排错效能。设计中采用了基于信息熵（Information Entropy）或启发式分割算法来选择最佳测试点，目标是使每一步测试都能最大程度地减少故障隔离集的不确定性。推理过程被建模为一个状态机，每当用户输入一个测试结果，`DiagnosisGraph`即更新当前的状态节点，并实时计算下一步推荐操作。为了满足“单步推理时间小于1秒”的性能指标，推理引擎采用了增量式计算策略，避免了每次交互都重新计算整个诊断树，同时利用内存缓存机制（`ProjectDataCache`）加速了中间数据的读取。

![交互式诊断推理流程图]
*(图2：交互式诊断推理流程图，描述从故障现象输入、D矩阵更新、最优测试选择到故障隔离的闭环逻辑)*

### 3.4 数据管理与接口设计

数据管理模块负责保证系统数据的完整性与可迁移性。系统定义了一套标准化的数据库Schema，涵盖了工程信息表、组件库表、信号定义表及故障模式表等。`SqliteDatabase`类实现了针对SQLite的封装，支持事务回滚与并发访问控制，确保在异常断电等情况下数据不丢失。在文件格式方面，软件支持`.swPro`复合文档格式，内部包含了数据库文件、配置文件及资源文件，便于项目的归档与分发。为了实现与外部系统的互联互通，设计中预留了标准的XML与JSON数据交换接口（`TModelParser`），支持导入外部CAD数据或导出测试性报告。此外，针对AI辅助功能的集成，`DeepSeekClient`类封装了RESTful API调用逻辑，允许系统将当前的故障上下文发送至云端大模型，获取基于自然语言的维修建议或辅助决策信息。

## 4. 关键算法与数学模型

本软件的核心竞争力在于其基于数学模型的精确推理能力。在依赖矩阵生成阶段，设系统包含故障集 $F = \{f_1, f_2, ..., f_n\}$ 和测试集 $T = \{t_1, t_2, ..., t_m\}$，相关性矩阵 $D$ 的元素定义为：

$$
d_{ij} = \begin{cases} 
1, & \text{若测试 } t_i \text{ 能够检测到故障 } f_j \\
0, & \text{否则}
\end{cases}
$$

在交互式诊断过程中，为了选择最优测试点，系统采用信息增益作为评价指标。假设当前故障隔离集为 $S \subseteq F$，对于任一候选测试 $t_k$，其将集合 $S$ 分割为检测通过子集 $S_{pass}$ 和检测失败子集 $S_{fail}$。若故障的先验概率分布为 $P(f_j)$，则当前集合的信息熵 $H(S)$ 定义为：

$$
H(S) = - \sum_{f_j \in S} \frac{P(f_j)}{P(S)} \log_2 \frac{P(f_j)}{P(S)}
$$

其中 $P(S) = \sum_{f_j \in S} P(f_j)$。测试 $t_k$ 的期望信息增益 $\Delta H(t_k)$ 为：

$$
\Delta H(t_k) = H(S) - [P(t_k=\text{pass}) \cdot H(S_{pass}) + P(t_k=\text{fail}) \cdot H(S_{fail})]
$$

系统在每一步推理中遍历所有可用测试，选择 $\Delta H(t_k)$ 最大的测试作为推荐操作。对于包含复杂逻辑约束（如与/或门、条件开关）的系统，在构建D矩阵前，需先通过Z3求解器验证路径的可达性。设路径 $Path$ 由一系列节点和边组成，其逻辑约束为 $\Phi$，则该路径有效的充要条件是 $\Phi$ 在SMT理论下是可满足的（Satisfiable），即 $SAT(\Phi) = \text{True}$。通过这种严谨的数学推导，确保了诊断方案的逻辑正确性与完备性。

![D矩阵生成与优化原理图]
*(图3：D矩阵生成与优化原理图，展示从物理拓扑到信号流图，再到经Z3求解器约减的依赖矩阵的转换过程)*

## 5. 接口设计与扩展性

为了支撑系统的长期演进与生态建设，T-Designer在接口设计上遵循了标准化与松耦合的原则。内部模块间主要通过C++接口类（Interface Classes）与Qt信号槽机制进行通信。例如，诊断引擎通过`IDiagnosisStrategy`接口与具体的推理算法解耦，允许未来插件化地引入新的诊断策略（如基于深度学习的故障预测）。外部接口方面，除了上述的文件导入导出接口外，系统还设计了硬件在环（HIL）接口层的抽象类`AbstractHardwareInterface`，虽然当前版本主要处理离线数据，但这为未来直接通过总线（如1553B、CAN）采集实时装备数据预留了通道。代码库中的`add_missing_indexes.py`等辅助脚本的存在，也体现了系统在运维层面提供了数据一致性检查与自动修复的接口工具，增强了软件在实际部署环境中的健壮性。

## 6. 结论

综上所述，T-Designer软件的设计方案紧密围绕“总体方案及项目关键技术”中的核心需求，通过分层的架构设计、严谨的数学模型以及高效的算法实现，构建了一个功能完备、性能优越的测试性建模与诊断平台。代码库中对`BO/DO`分离模式的运用、Z3求解器的深度集成以及SQLite数据库的事务化管理，均体现了软件工程的高标准实践。经测试大纲验证，该设计不仅在功能上实现了从建模到诊断的全覆盖，更在性能指标上达到了亚秒级响应与万级节点支持的预定目标，具备较高的技术成熟度与工程应用价值。