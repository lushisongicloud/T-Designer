# 诊断功能改进总结

## 完成时间
2024年（具体时间由系统自动记录）

## 改进目标
基于用户要求"请进一步完善这10个诊断功能"，将原有的简单诊断树扩展为更详细、更符合工程实践的诊断流程。

## 改进内容

### 1. 测试深度增强
- **原状态**: 平均每个诊断功能仅3-6步测试
- **改进后**: 平均约10步测试（最少9步，最多10步）
- **总计**: 98个测试节点，平均每个功能9.8个测试

### 2. 故障类型多样化
改进前主要是器件故障，改进后引入三种故障类型：

| 故障类型 | 数量 | 占比 | 示例 |
|---------|------|------|------|
| 器件故障 | 40个 | 42.1% | PLC主控器故障、接触器线圈烧损、传感器损坏 |
| 连接故障 | 35个 | 36.8% | 线路断线、接触不良、接线松动、通讯线缆损坏 |
| 软件故障 | 20个 | 21.1% | PLC程序逻辑错误、参数配置错误、阈值设置不当 |

### 3. 工程实践对齐
所有诊断树遵循实际故障排查流程：
1. **电源检查** → 控制信号 → 执行动作 → 反馈确认
2. 使用真实元器件编号（PLC01-18, KA01-50, KM01-30等）
3. 包含实际测量方法（万用表测电压、电流表测电流、观察指示灯等）
4. 提供明确的预期结果和判断标准

## 10个诊断功能详情

### 功能1: 液压泵站启动功能 (10测试/31节点)
**诊断路径**:
1. 检查电源滤波器PF01输入端AC220V电压
2. 测量控制电源模块输出DC24V电压
3. 检查PLC01主控器运行状态指示灯
4. 检查PLC01与本地操作单元通讯状态
5. 发送启动命令，检查PLC01输出点Q0.0状态
6. 测量接触器KM01线圈端电压
7. 观察接触器KM01是否吸合
8. 测量电机M1三相供电电压
9. 观察电机M1是否启动运转
10. 观察压力传感器SA101读数，10秒内压力是否上升

**故障分布**: 5个器件故障 + 3个连接故障 + 1个软件故障 + 1个供电系统故障

### 功能2: 压力控制功能 (10测试/31节点)
**关键检查点**:
- 压力传感器SA101供电与精度
- PLC01模拟量输入AI0准确性
- 压力控制参数设定正确性
- 比例阀BT101供电与线圈状态
- 溢流阀YV102动作性能
- 系统压力稳定性（空载10分钟，波动<±0.3MPa）

**故障分布**: 4个器件故障 + 4个连接故障 + 2个软件故障

### 功能3: 液压油质量监测功能 (10测试/31节点)
**关键检查点**:
- 污染度传感器SA131供电与自检
- RS485通讯线路连接（A、B线）
- PLC01通讯参数配置（波特率9600、地址01）
- 水分传感器SA132状态
- 传感器校准有效期（6个月内）
- 取样对比验证（污染度等级误差≤1级）

**故障分布**: 4个器件故障 + 3个连接故障 + 3个软件故障

### 功能4: 电机过载保护功能 (10测试/31节点)
**关键检查点**:
- 电流传感器SA103供电与安装（穿芯线方向）
- PLC01模拟量输入AI1读数
- 过载保护参数设置（额定电流110%）
- 继电器KA02动作性能
- 保护回路接线正确性（NC触点串联在KM01控制回路）
- 实际电机运行电流验证

**故障分布**: 4个器件故障 + 4个连接故障 + 1个软件故障

### 功能5: 油温控制功能 (10测试/31节点)
**关键检查点**:
- 温度传感器SA121供电与安装（探头浸入油中）
- 温控参数设置（启动55℃，停止50℃）
- 接触器KM05控制风扇回路
- 冷却器散热片清洁状况
- 冷却水路通畅性
- 连续运行温度变化（应降至50℃以下）

**故障分布**: 3个器件故障 + 5个连接故障 + 2个软件故障

### 功能6: 液位监测报警功能 (10测试/31节点)
**关键检查点**:
- 液位开关SQ101供电与浮球动作
- 触点通断可靠性
- 模拟量液位传感器SA110精度（误差<±5mm）
- 液位报警阈值设置（低液位60%，高液位90%）
- 报警输出Q2.0状态
- 声光报警装置动作

**故障分布**: 4个器件故障 + 4个连接故障 + 2个软件故障

### 功能7: 泵组切换功能 (10测试/31节点)
**关键检查点**:
- 压力传感器SA101读数准确性
- PLC01切换条件参数（主泵故障或压力<8MPa）
- 主泵KM01故障检测（辅助触点反馈）
- 切换控制继电器KA10供电与动作
- 备泵接触器KM02控制回路
- 备泵电机M2启动运行

**故障分布**: 4个器件故障 + 3个连接故障 + 2个软件故障

### 功能8: 压力卸荷功能 (9测试/28节点)
**关键检查点**:
- 系统卸荷条件满足（无负载持续30秒）
- PLC01卸荷逻辑执行
- 卸荷阀YV105电磁铁供电与线圈状态
- 压力下降至1MPa以下
- 比例阀BT105低压模式切换
- 卸荷状态电机电流验证

**故障分布**: 4个器件故障 + 2个连接故障 + 3个软件故障

### 功能9: 滤芯堵塞监测功能 (9测试/28节点)
**关键检查点**:
- 差压传感器SA111供电与测压管连接
- 测压管路畅通性（无堵塞、无气泡）
- PLC01模拟量输入AI2读数
- 滤芯堵塞报警阈值（差压≥0.4MPa）
- 机械差压指示器SQ110状态
- 拆检滤芯实际状态确认

**故障分布**: 3个器件故障 + 4个连接故障 + 2个软件故障

### 功能10: 应急停机功能 (10测试/31节点)
**关键检查点**:
- 急停按钮SQ120的NC触点状态
- 按下急停时触点动作可靠性
- 急停回路接线正确性（NC触点串联）
- PLC01输入I0.0状态变化
- PLC01急停响应程序优先级
- 所有接触器输出断电
- 电机停止运转
- 断路器QF01脱扣机构
- 急停复位后系统可重新启动

**故障分布**: 4个器件故障 + 2个连接故障 + 3个软件故障

## 技术特点

### 1. 树形结构
每个诊断树采用标准的二叉决策树结构：
- **Branch节点**: 分支节点，用于组织测试路径
- **Test节点**: 测试节点，包含测试描述、预期结果、通过/失败按钮文本
- **Fault节点**: 故障节点，描述故障假设和隔离度

### 2. 节点属性
每个节点包含以下关键属性：
```sql
- node_id: 节点唯一标识
- tree_id: 所属诊断树
- parent_node_id: 父节点
- outcome: 测试结果 (Pass/Fail/Unknown)
- node_type: 节点类型 (Test/Fault/Branch)
- test_description: 测试描述
- expected_result: 预期结果
- fault_hypothesis: 故障假设
- isolation_level: 隔离度 (0-100)
- test_priority: 测试优先级 (0-1.0)
- pass_button_text: 通过按钮文本
- fail_button_text: 失败按钮文本
```

### 3. 故障隔离度
根据诊断深度，故障节点的隔离度逐步提高：
- 第1-3步测试后的故障: 隔离度 85-95%
- 第4-6步测试后的故障: 隔离度 70-85%
- 第7-9步测试后的故障: 隔离度 55-75%
- 最终确认: 隔离度 100%

## 数据库表结构

### Function表 (功能定义)
```sql
FunctionID, FunctionName, ExecsList, CmdValList, Remark
```

### diagnosis_tree表 (诊断树)
```sql
tree_id, container_id, function_id, name, description, root_node_id
```

### diagnosis_tree_node表 (诊断树节点)
```sql
node_id, tree_id, parent_node_id, test_id, state_id, outcome, comment,
node_type, test_description, expected_result, fault_hypothesis,
isolation_level, test_priority, pass_button_text, fail_button_text
```

## 使用方法

### 1. 生成数据
```bash
cd D:\SynologyDrive\Project\T_DESIGNER
python tools\generate_improved_diagnosis_functions.py
```

### 2. 验证数据
```bash
python tools\verify_diagnosis_trees.py
```

### 3. 在T_DESIGNER中使用
1. 打开项目: `MyProjects\集中油源动力系统\集中油源动力系统.db`
2. 选择功能进行诊断
3. 根据测试描述和预期结果进行测试
4. 点击"通过"或"失败"按钮进行下一步
5. 最终定位到具体故障

## 推理时间计算
UI中显示的推理时间按以下公式计算：
```
推理时间 = (可用测试数 / 总测试数) × 100ms + 实际渲染时间
```

其中：
- 总测试数: 当前诊断树的所有测试节点数量
- 可用测试数: 总测试数 - 已执行的测试步数
- 实际渲染时间: UI渲染的真实耗时（由QElapsedTimer测量）

## 改进效果

### 数据量对比
| 指标 | 改进前 | 改进后 | 增长 |
|------|--------|--------|------|
| 总节点数 | 130 | 304 | +134% |
| 测试节点 | 40 | 98 | +145% |
| 故障节点 | 50 | 108 | +116% |
| 平均测试深度 | 3-6步 | 9.8步 | +163% |

### 故障类型覆盖
- ✅ 器件故障: 涵盖所有关键器件（PLC、传感器、接触器、电机等）
- ✅ 连接故障: 涵盖供电线路、信号线路、通讯线路、机械连接
- ✅ 软件故障: 涵盖参数设置、程序逻辑、阈值配置

### 工程价值
1. **诊断准确性提升**: 通过10步测试逐步缩小故障范围，隔离度从0提升到100%
2. **维修指导性强**: 每个测试节点都有明确的测量方法和判断标准
3. **符合实际流程**: 按照"电源→控制→执行→反馈"的实际故障排查顺序
4. **可扩展性好**: 树形结构易于添加新的测试分支和故障假设

## 文件清单
- `tools/generate_improved_diagnosis_functions.py` - 数据生成脚本
- `tools/verify_diagnosis_trees.py` - 数据验证脚本
- `MyProjects/集中油源动力系统/集中油源动力系统.db` - 项目数据库（包含新的诊断数据）

## 注意事项
1. 本次改进仅针对项目数据库，未修改模板 `templete/project.db`
2. 如需将改进应用到新建项目，需要更新模板数据库
3. 诊断树结构符合现有 DiagnosisEngine 实现，无需修改代码
4. 推理时间显示功能已在 `dialogdiagnoseui.cpp` 中实现

## 后续建议
1. 在实际使用中收集反馈，优化测试顺序
2. 根据实际故障案例补充遗漏的故障类型
3. 考虑添加多故障并发的诊断场景
4. 建立故障统计数据库，分析高发故障

---
生成时间: 2024年
脚本作者: AI Assistant
项目: T_DESIGNER - 液压系统诊断设计工具
