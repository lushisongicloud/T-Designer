# T语言模型自动生成功能使用说明

## 功能概述

本功能使用 DeepSeek AI 自动为器件库中的器件生成 T 语言模型，包括：
1. 自动识别端口类型（电气/液压/机械）
2. 自动设置端口变量和连接宏
3. 自动生成内部变量定义
4. 自动生成正常模式约束
5. 自动生成故障模式定义

## 准备工作

### 1. 获取 DeepSeek API Key

1. 访问 DeepSeek 官网注册账号
2. 获取 API Key

### 2. 设置环境变量

**Windows 系统：**

1. 右键"此电脑" → "属性" → "高级系统设置" → "环境变量"
2. 在"用户变量"中点击"新建"
3. 变量名：`DEEPSEEK_API_KEY`
4. 变量值：粘贴你的 API Key
5. 确定并重启 T-Designer 应用程序

## 使用步骤

### 1. 打开本地物料库

主界面 → 数据管理 → 本地物料库

### 2. 选择器件

在器件列表中选择任意器件（功能仅在"自动编写"时批量处理所有符合条件的器件）

### 3. 点击"自动编写"按钮

在"T语言模型"标签页中，点击"编译"按钮右侧的"自动编写"按钮

### 4. 确认开始

系统会弹出确认对话框，说明：
- 会跳过没有端口定义或没有描述信息的器件
- 自动设置端口类型并生成模型
- 每个器件最多尝试 3 次
- 会生成日志文件记录处理过程

点击"是"开始自动生成

### 5. 观察生成过程

会弹出一个非模态对话框，实时显示：
- 当前处理的器件信息和进度
- 发送给 AI 的原始输入
- AI 的思考过程
- AI 的最终输出

### 6. 等待完成

处理完成后会弹出提示框，可以查看日志文件了解详细信息

## 日志文件

日志文件自动生成在当前目录，文件名格式：
```
tmodel_auto_gen_YYYYMMDD_HHMMSS.log
```

日志内容包括：
- 每个器件的处理过程
- AI 的输入和输出
- 端口配置保存结果
- T 模型校验结果
- 错误信息和重试记录

## 跳过的器件

以下情况的器件会被跳过：
1. 没有定义任何端口（功能子块和端口号为空）
2. 没有描述信息（Equipment_Desc 为空）
3. 校验失败且重试 3 次后仍失败

## 生成的内容

### 1. 端口配置

保存到 `port_config` 表：
- 端口类型（electric/hydraulic/mechanical）
- 变量列表（i,u / p,q / F,x）
- 连接宏族（electric-connect / hydraulic-connect / mechanical-connect）

### 2. T 语言模型

保存到 `Equipment_Template.TModel` 字段：
```smt-lib2
;; 端口变量（由系统自动生成）
%PORT_VARS%

;; 内部变量定义
(declare-const %Name%.R Real) ; 电阻
(assert (> %Name%.R 0))

;; 正常模式
(define-fun %Name%_normal () Bool
  (and
    ;; 约束条件
  )
)

;; 故障模式
(define-fun %Name%_fault_open () Bool
  ;; 开路故障
)

(define-fun %Name%_fault_short () Bool
  ;; 短路故障
)
```

## 注意事项

1. **API Key 保护**：不要将 API Key 提交到版本控制系统
2. **网络连接**：需要稳定的互联网连接
3. **处理时间**：根据器件数量，可能需要较长时间
4. **费用**：DeepSeek API 调用会产生费用，请注意账户余额
5. **结果检查**：建议在自动生成后手动检查和调整生成的模型
6. **备份**：在批量自动生成前，建议备份数据库

## 故障排查

### 问题1：提示 API Key 未设置

**解决方案**：
1. 检查环境变量是否正确设置
2. 重启 T-Designer 应用程序
3. 使用 PowerShell 验证：`$env:DEEPSEEK_API_KEY`

### 问题2：网络连接失败

**解决方案**：
1. 检查网络连接
2. 检查防火墙设置
3. 检查代理设置

### 问题3：生成结果不理想

**解决方案**：
1. 完善器件的描述信息
2. 检查端口定义是否完整
3. 手动调整生成的模型
4. 查看日志文件了解 AI 的思考过程

### 问题4：对话框无响应

**解决方案**：
1. 查看日志文件确认是否在处理
2. 检查网络连接
3. 等待超时后重试

## 技术细节

### 生成流程

```
1. 加载器件列表（有端口且有描述）
   ↓
2. 识别端口类型（调用 DeepSeek API）
   ↓
3. 保存端口配置
   ↓
4. 生成内部变量定义（调用 DeepSeek API）
   ↓
5. 生成正常模式（调用 DeepSeek API）
   ↓
6. 生成故障模式（调用 DeepSeek API）
   ↓
7. 组装完整 T 模型
   ↓
8. 校验模型
   ↓
9. 保存到数据库
   ↓
10. 下一个器件
```

### 重试机制

- 每个阶段失败后自动重试
- 最多重试 3 次
- 重试信息记录在日志中

### AI 提示词

系统使用精心设计的提示词引导 AI 生成符合规范的模型：
- 系统提示：定义 SMT-LIB2 规范和基本规则
- 用户提示：提供器件具体信息和生成要求

## 后续改进

1. 支持更多器件类型
2. 优化提示词提高生成质量
3. 支持增量更新（只更新部分内容）
4. 支持自定义模板
5. 集成更多验证规则

## 联系支持

如有问题或建议，请联系开发团队。
