# T语言模型功能测试清单

## 编译修复记录

### 已修复的编译错误
1. ✅ `dialogunitmanage.cpp` - ListRepairInfo 未声明
2. ✅ `dialogUnitAttr.cpp` - ListRepairInfo 未声明
3. ✅ `dialogunitmanage.cpp` - EdPartCode 改为 EdUnitCode

## 功能测试清单

### 一、常量管理功能测试

#### 1.1 本地物料库（dialogunitmanage）

**测试入口**：主界面 → 数据管理 → 本地物料库

- [ ] **新增常量**
  - [ ] 在tableWidgetStructure空白区域右键 → 选择"新增"
  - [ ] 验证新增一行空白行
  - [ ] 验证自动进入常量名编辑模式
  - [ ] 输入常量名、值、单位、备注
  - [ ] 验证所有列都可双击编辑

- [ ] **删除常量**
  - [ ] 选中1行 → 右键 → 选择"删除"
  - [ ] 验证直接删除（无二次确认）
  - [ ] 选中多行（>1行）→ 右键 → 选择"删除"
  - [ ] 验证弹出二次确认对话框
  - [ ] 确认删除后验证所有选中行被删除

- [ ] **插入常量名到编辑器**
  - [ ] 在常量名列右键 → 选择"插入常量名到T语言模型"
  - [ ] 验证在QsciEdit光标位置插入`%常量名%`格式
  - [ ] 验证编辑器获得焦点

- [ ] **编辑常量**
  - [ ] 双击任意单元格进入编辑模式
  - [ ] 修改内容后按回车或点击其他位置
  - [ ] 验证修改被保存

- [ ] **常量名验证**
  - [ ] 尝试添加空常量名
  - [ ] 点击"应用"保存
  - [ ] 验证空常量名不会被保存

#### 1.2 元件属性（dialogUnitAttr）

**测试入口**：项目导航器 → 元件tab → 右键实体元件 → 元件属性

- [ ] 重复1.1中的所有测试步骤
- [ ] 验证功能与本地物料库完全一致

### 二、T语言模型编译功能测试

#### 2.1 编译按钮功能

**测试用例1：基本编译**

T语言模型内容：
```smt
;;端口变量定义
(declare-fun %Name%.A1.i () Real)
(declare-fun %Name%.A1.u () Real)

;;内部变量定义
(declare-fun %Name%.R () Real)

;;正常模式
(assert (= %Name%.R %电阻值%))
(assert (= %Name%.A1.u (* %Name%.R %Name%.A1.i)))

;;故障模式
;;"开路"
(assert (= %Name%.A1.i 0))
```

常量表：
| 常量名 | 值 | 单位 | 备注 |
|--------|-----|------|------|
| 电阻值 | 100 | Ω | 内阻 |

测试步骤：
- [ ] 在T语言模型编辑器中输入上述内容
- [ ] 在常量表中添加"电阻值"常量
- [ ] 器件代号设置为"R1"
- [ ] 点击"编译"按钮
- [ ] 验证弹出编译结果对话框
- [ ] 验证显示4个标签页：
  1. [ ] 端口变量定义 - 包含替换后的`R1.A1.i`和`R1.A1.u`
  2. [ ] 内部变量定义 - 包含替换后的`R1.R`
  3. [ ] 正常模式 - 包含替换后的`R1.R`和常量值`100`
  4. [ ] 故障模式 - 包含子标签"开路"

**测试用例2：公共约束展开**

T语言模型内容：
```smt
;;端口变量定义
(declare-fun %Name%.A1.i () Real)
(declare-fun %Name%.A1.u () Real)

;;正常模式
(assert (= %Name%.A1.u (* 10 %Name%.A1.i)))

;;故障模式
;;公共开始
(assert (= 0 (+ %Name%.A1.i %Name%.A1.u)))
;;"故障1"
(assert (= %Name%.A1.i %常量1%))
;;"故障2"
(assert (= %Name%.A1.u %常量2%))
;;公共结束
```

常量表：
| 常量名 | 值 | 单位 | 备注 |
|--------|-----|------|------|
| 常量1 | 5 | A | |
| 常量2 | 10 | V | |

测试步骤：
- [ ] 输入上述内容
- [ ] 器件代号设置为"K1"
- [ ] 点击"编译"
- [ ] 验证故障模式标签页中有2个子标签："故障1"和"故障2"
- [ ] 打开"故障1"子标签，验证包含：
  - [ ] 公共约束`(assert (= 0 (+ K1.A1.i K1.A1.u)))`
  - [ ] 特有约束`(assert (= K1.A1.i 5))`（常量已替换）
- [ ] 打开"故障2"子标签，验证包含：
  - [ ] 公共约束`(assert (= 0 (+ K1.A1.i K1.A1.u)))`
  - [ ] 特有约束`(assert (= K1.A1.u 10))`（常量已替换）

**测试用例3：未定义常量**

- [ ] T语言模型中使用`%未定义常量%`
- [ ] 常量表中没有"未定义常量"
- [ ] 点击"编译"
- [ ] 验证编译成功（不报错）
- [ ] 验证编译结果中保留`%未定义常量%`未替换

**测试用例4：空器件代号**

- [ ] 器件代号留空
- [ ] 点击"编译"
- [ ] 验证使用默认名称"COMPONENT"

### 三、数据持久化测试

#### 3.1 保存测试

**本地物料库**
- [ ] 选择一个器件
- [ ] 在常量表中添加/修改常量
- [ ] 点击"应用"按钮
- [ ] 关闭对话框
- [ ] 重新打开对话框并选择同一器件
- [ ] 验证常量数据已保存并正确加载

**元件属性**
- [ ] 在项目中选择一个元件
- [ ] 打开元件属性
- [ ] 在常量表中添加/修改常量
- [ ] 点击"确定"按钮
- [ ] 重新打开元件属性
- [ ] 验证常量数据已保存并正确加载

#### 3.2 数据格式测试

- [ ] 手动查看数据库Equipment表的Structure字段
- [ ] 验证格式为：`常量名1,值1,单位1,备注1;常量名2,值2,单位2,备注2`
- [ ] 验证空常量名的行不会被保存
- [ ] 验证包含逗号的值是否正确处理（边界情况）

### 四、两处界面一致性测试

#### 4.1 界面布局对比
- [ ] 同时打开本地物料库和元件属性
- [ ] 对比tableWidgetStructure表格布局
- [ ] 验证列数、列名、列宽一致
- [ ] 验证选择模式一致（行选择、多选）

#### 4.2 功能行为对比
- [ ] 在两处界面分别测试右键菜单
- [ ] 验证菜单项完全一致
- [ ] 验证"新增"功能行为一致
- [ ] 验证"删除"功能行为一致（单个/批量）
- [ ] 验证"插入常量名"功能行为一致
- [ ] 验证"编译"按钮功能一致

#### 4.3 数据格式兼容性
- [ ] 在本地物料库中编辑器件并添加常量
- [ ] 在项目中添加该器件实例
- [ ] 打开元件属性
- [ ] 验证常量数据正确继承（如果设计为继承的话）

### 五、边界情况测试

#### 5.1 特殊字符处理
- [ ] 常量名包含特殊字符（如：`常量-1`、`常量_1`）
- [ ] 常量值包含逗号（如：`1,000`）
- [ ] 常量值包含分号（如：`值;备注`）
- [ ] 常量值包含百分号（如：`50%`）
- [ ] 验证保存和加载是否正确

#### 5.2 大量数据性能
- [ ] 添加100个常量
- [ ] 验证表格滚动流畅
- [ ] 验证保存速度可接受
- [ ] 验证加载速度可接受
- [ ] 验证编译速度可接受

#### 5.3 空值处理
- [ ] 常量名为空 → 保存时跳过
- [ ] 常量值为空 → 保存为空字符串
- [ ] T语言模型为空 → 编译时提示或返回空结果
- [ ] Structure字段为空 → 加载时表格为空

#### 5.4 解析错误处理
- [ ] T语言模型格式错误（缺少特殊注释标记）
- [ ] 验证是否给出明确错误提示
- [ ] 故障模式名不规范（缺少引号）
- [ ] 验证解析行为

### 六、集成测试

#### 6.1 完整工作流
1. [ ] 在本地物料库中创建新器件模板
2. [ ] 添加T语言模型（包含端口变量、内部变量、正常模式、故障模式）
3. [ ] 添加常量定义
4. [ ] 点击"编译"验证模型正确性
5. [ ] 保存器件模板
6. [ ] 在项目中使用该器件
7. [ ] 打开元件属性
8. [ ] 修改元件的T语言模型和常量
9. [ ] 编译验证
10. [ ] 保存元件

#### 6.2 与现有功能兼容性
- [ ] 验证修改不影响功能子块（tableWidgetSpur）
- [ ] 验证修改不影响端子信息（tableTerm）
- [ ] 验证修改不影响维修信息（tableRepairInfo）
- [ ] 验证修改不影响图片管理（tableWidgetUnitPic）

## 已知问题和注意事项

1. **数据库字段复用**
   - Structure字段原本用于Livingstone的enum变量
   - 现在改为存储常量信息
   - ⚠️ 如果数据库中有旧数据，需要手动清理

2. **T语言模型校验**
   - 当前只实现编译展开功能
   - 尚未集成SMT语法校验
   - 尚未实现端口一致性校验

3. **常量引用检查**
   - 编译时不检查引用的常量是否已定义
   - 未定义的常量保持`%常量名%`格式

4. **公共块作用域**
   - 公共块累积到所有后续故障模式
   - 直到遇到"公共结束"或文件末尾

## 测试结果记录

### 测试环境
- 操作系统：Windows
- Qt版本：5.12.9
- 编译器：MSVC 2017
- 数据库：SQLite

### 测试日期
- 计划测试日期：2025年10月30日
- 实际测试日期：___________

### 测试人员
- 测试人员：___________
- 审核人员：___________

### 缺陷统计
| 严重程度 | 数量 | 描述 |
|----------|------|------|
| 致命 | | |
| 严重 | | |
| 一般 | | |
| 轻微 | | |

### 测试结论
- [ ] 通过
- [ ] 有条件通过（需修复部分缺陷）
- [ ] 不通过（需重新测试）

### 备注
```
（记录测试过程中发现的问题、建议等）
```
