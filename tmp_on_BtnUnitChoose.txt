void DialogUnitAttr::on_BtnUnitChoose_clicked() //dataFunc 从器件库中载入器件信息到界面
{
    //DialogUnitManage *dlg=new DialogUnitManage(this);
    dlgUnitManage->setModal(true);
    dlgUnitManage->SetStackWidget(0);
    dlgUnitManage->show();
    dlgUnitManage->exec();
    if(dlgUnitManage->Canceled) return;
    LibEquipment_ID=dlgUnitManage->CurEquipment_ID;//在弹出对话框的器件库中选择器件，返回器件的Equipment_ID

    //=====根据选择的器件的Equipment_ID，在器件库数据库中查询相关信息，并加载到界面中来=====
    QSqlQuery QueryEquipment= QSqlQuery(T_LibDatabase);
    QString SqlStr=QString("SELECT * FROM Equipment WHERE Equipment_ID='"+LibEquipment_ID+"'");
    QueryEquipment.exec(SqlStr);
    if(!QueryEquipment.next()) return;
    if(QueryEquipment.value("PartCode").toString()==ui->CbPartCode->currentText()) return;
    UnitTypeChanged=true;
    ui->CbPartCode->setCurrentText(QueryEquipment.value("PartCode").toString());
    ui->LbType->setText(QueryEquipment.value("Type").toString());
    ui->LbName->setText(QueryEquipment.value("Name").toString());
    ui->LbFactory->setText(QueryEquipment.value("Supplier").toString());
    ui->LbOrderNum->setText(QueryEquipment.value("OrderNum").toString());
    ui->tableWidgetUnitAttr->item(0,1)->setText(QueryEquipment.value("Desc").toString());
    ui->EdMTBF->setText(QueryEquipment.value("MTBF").toString());
    QsciEdit->setText(QueryEquipment.value("TModel").toString());
    on_BtnCompile_clicked();
    QStringList ListStructure=QueryEquipment.value("Structure").toString().split(";");
    if(ListStructure.count()==ui->tableWidgetStructure->rowCount())
    {
        for(int i=0;i<ListStructure.count();i++)
        {
            if(ui->tableWidgetStructure->item(i,0)->text()!=ListStructure.at(i).split(",").at(0)) continue;
            ((QComboBox *)ui->tableWidgetStructure->cellWidget(i,2))->setCurrentText(ListStructure.at(i).split(",").at(1));
            ((QComboBox *)ui->tableWidgetStructure->cellWidget(i,3))->setCurrentText(ListStructure.at(i).split(",").at(2));
        }
    }

    //Lu ToDo 照片及标注信息加载
    //ui->tableWidgetUnitPic有两列：图片;已标注
    //其中第1列显示图片路径（如果找到了图片则显示绝对路径，没找到则显示图片文件名）；第1列的Qt::UserRole的Data存储图片绝对路径（没找到图片则为空）
    //第2列显示“是”或“否”表示是否已标注，第2列的Qt::UserRole的Data存储StrTagInfo
    //图片先在QDir projectPicDir(CurProjectPath + PROJECT_PIC_PATH)目录下查找，剩下没找到的在QDir BasePicDir(QString(PIC_BASE_PATH) + "/" + supplier)下查找，剩下没找到的在QDir BasePicDir(QString(PIC_BASE_PATH))下查找,还没找到的，则在第1列只显示图片文件名，也不显示图片。
    fillUnitPicTable(QueryEquipment.value("Picture").toString(),QueryEquipment.value("Supplier").toString());

    //维修信息
    ui->tableRepairInfo->setRowCount(0);
    for(int i=0;i<ui->tableWidgetStructure->rowCount();i++)
    {
        if(ui->tableWidgetStructure->item(i,1)->text()=="ModeType")
        {
            QComboBox *CbModeTypeBox= ((QComboBox *)ui->tableWidgetStructure->cellWidget(i,2));
            for(int j=0;j<CbModeTypeBox->count();j++)
            {
                if((CbModeTypeBox->itemText(j)=="nominal")||(CbModeTypeBox->itemText(j)=="undefined")||(CbModeTypeBox->itemText(j)=="default")) continue;
                if((CbModeTypeBox->itemText(j)=="on")||(CbModeTypeBox->itemText(j)=="off")||(CbModeTypeBox->itemText(j)=="open")||(CbModeTypeBox->itemText(j)=="close")) continue;
                ui->tableRepairInfo->setRowCount(ui->tableRepairInfo->rowCount()+1);
                ui->tableRepairInfo->setItem(ui->tableRepairInfo->rowCount()-1,0,new QTableWidgetItem(ui->tableWidgetStructure->item(i,0)->text()));
                ui->tableRepairInfo->setItem(ui->tableRepairInfo->rowCount()-1,1,new QTableWidgetItem(CbModeTypeBox->itemText(j)));
                ui->tableRepairInfo->setItem(ui->tableRepairInfo->rowCount()-1,2,new QTableWidgetItem(""));
                ui->tableRepairInfo->setItem(ui->tableRepairInfo->rowCount()-1,3,new QTableWidgetItem(""));
            }
        }
    }
    QStringList ListRepairInfo=QueryEquipment.value("RepairInfo").toString().split("￤￤");
    if(ListRepairInfo.count()==ui->tableRepairInfo->rowCount())
    {
        for(int i=0;i<ListRepairInfo.count();i++)
        {
            if(ListRepairInfo.at(i).split("￤").count()==4)
            {
                if(ui->tableRepairInfo->item(i,0)->text()!=ListRepairInfo.at(i).split("￤").at(0)) continue;
                if(ui->tableRepairInfo->item(i,1)->text()!=ListRepairInfo.at(i).split("￤").at(1)) continue;
                ui->tableRepairInfo->item(i,2)->setText(ListRepairInfo.at(i).split("￤").at(2));
                ui->tableRepairInfo->item(i,3)->setText(ListRepairInfo.at(i).split("￤").at(3));
            }
        }
    }
    //维修信息=====结束

    //器件实例化参数加载
    ui->tableUnitDiagnosePara->setRowCount(0);
    QSqlQuery QueryEquipmentDiagnosePara= QSqlQuery(T_LibDatabase);
    SqlStr="SELECT * FROM EquipmentDiagnosePara WHERE Equipment_ID= '"+LibEquipment_ID+"'";
    QueryEquipmentDiagnosePara.exec(SqlStr);
    while(QueryEquipmentDiagnosePara.next())
    {
        ui->tableUnitDiagnosePara->setRowCount(ui->tableUnitDiagnosePara->rowCount()+1);
        ui->tableUnitDiagnosePara->setItem(ui->tableUnitDiagnosePara->rowCount()-1,0,new QTableWidgetItem(QueryEquipmentDiagnosePara.value("Name").toString()));//名称
        ui->tableUnitDiagnosePara->item(ui->tableUnitDiagnosePara->rowCount()-1,0)->setData(Qt::UserRole,QueryEquipmentDiagnosePara.value("DiagnoseParaID").toString());
        ui->tableUnitDiagnosePara->setItem(ui->tableUnitDiagnosePara->rowCount()-1,1,new QTableWidgetItem(QueryEquipmentDiagnosePara.value("Unit").toString()));//单位
        ui->tableUnitDiagnosePara->setItem(ui->tableUnitDiagnosePara->rowCount()-1,2,new QTableWidgetItem(QueryEquipmentDiagnosePara.value("DefaultValue").toString()));//当前值
        ui->tableUnitDiagnosePara->setItem(ui->tableUnitDiagnosePara->rowCount()-1,3,new QTableWidgetItem(QueryEquipmentDiagnosePara.value("DefaultValue").toString()));//默认值
        ui->tableUnitDiagnosePara->setItem(ui->tableUnitDiagnosePara->rowCount()-1,4,new QTableWidgetItem(QueryEquipmentDiagnosePara.value("Remark").toString()));//备注
    }
    //器件实例化参数加载=====结束

    QSqlQuery QueryEquipmentTemplate= QSqlQuery(T_LibDatabase);
    SqlStr=QString("SELECT * FROM EquipmentTemplate WHERE Equipment_ID = '"+LibEquipment_ID+"'");
    QueryEquipmentTemplate.exec(SqlStr);
    ui->tableWidgetSpur->setRowCount(0);
    ui->tableTerm->setRowCount(0);
    QString VariableText="";
    QStringList ListInterConnectInfo;
    while(QueryEquipmentTemplate.next())
    {
        if((QueryEquipmentTemplate.value("FuncType").toString()=="虚拟端口-观测布尔量")||(QueryEquipmentTemplate.value("FuncType").toString()=="虚拟端口-观测实数量"))
        {
            if(VariableText!="") VariableText+="\n";
            QString UnitText="";
            if(QueryEquipmentTemplate.value("FuncType").toString()=="虚拟端口-观测布尔量") UnitText="Bool";
            else if(QueryEquipmentTemplate.value("FuncType").toString()=="虚拟端口-观测实数量") UnitText="Real";
            VariableText+="(declare-fun %"+ui->EdUnitTag->text()+"%."+QueryEquipmentTemplate.value("FunDefine").toString()+" () "+UnitText+")";
        }
        ui->tableWidgetSpur->setRowCount(ui->tableWidgetSpur->rowCount()+1);
        QString UnitSpurStr,SpurDescStr;
        UnitSpurStr=QueryEquipmentTemplate.value("ConnNum").toString();
        SpurDescStr=QueryEquipmentTemplate.value("SpurDT").toString();
        //￤分割
        if((QueryEquipmentTemplate.value("FuncType").toString()=="接线端口")||(QueryEquipmentTemplate.value("FuncType").toString()==""))
        {
            if(UnitSpurStr!="")
            {
                QStringList ListTermConn=UnitSpurStr.split("￤");
                for(QString TermConn:ListTermConn)
                {
                    if(VariableText!="") VariableText+="\n";
                    VariableText+="(declare-fun %"+ui->EdUnitTag->text()+"%."+TermConn+".i () Real)\n";
                    VariableText+="(declare-fun %"+ui->EdUnitTag->text()+"%."+TermConn+".u () Real)";
                }
            }

        }
        ui->tableWidgetSpur->setItem(ui->tableWidgetSpur->rowCount()-1,0,new QTableWidgetItem(UnitSpurStr));
        ui->tableWidgetSpur->item(ui->tableWidgetSpur->rowCount()-1,0)->setData(Qt::UserRole,QVariant(QueryEquipmentTemplate.value("EquipmentTemplate_ID").toString()));
        ui->tableWidgetSpur->setItem(ui->tableWidgetSpur->rowCount()-1,1,new QTableWidgetItem(SpurDescStr));
        QTableWidgetItem *ItemSourceConn=new QTableWidgetItem(QueryEquipmentTemplate.value("SourcePrior").toString());//优先级
        if(QueryEquipmentTemplate.value("SourceConn").toBool()) ItemSourceConn->setCheckState(Qt::Checked);
        else
        {
            if((QueryEquipmentTemplate.value("FuncType").toString()=="")||(QueryEquipmentTemplate.value("FuncType").toString()=="接线端口"))
                ItemSourceConn->setCheckState(Qt::Unchecked);
        }
        //ItemSourceConn->setFlags(ItemSourceConn->flags()&(~Qt::ItemIsEditable));

        QTableWidgetItem *ItemExecConn=new QTableWidgetItem("");
        if(QueryEquipmentTemplate.value("ExecConn").toBool()) ItemExecConn->setCheckState(Qt::Checked);
        else
        {
            if((QueryEquipmentTemplate.value("FuncType").toString()=="")||(QueryEquipmentTemplate.value("FuncType").toString()=="接线端口"))
                ItemExecConn->setCheckState(Qt::Unchecked);
        }
        ItemExecConn->setFlags(ItemExecConn->flags()&(~Qt::ItemIsEditable));
        ui->tableWidgetSpur->setItem(ui->tableWidgetSpur->rowCount()-1,2,ItemSourceConn);//源端口
        ui->tableWidgetSpur->setItem(ui->tableWidgetSpur->rowCount()-1,3,ItemExecConn);//终端端口
        ui->tableWidgetSpur->setItem(ui->tableWidgetSpur->rowCount()-1,4,new QTableWidgetItem(QueryEquipmentTemplate.value("TestCost").toString()));
        ui->tableWidgetSpur->setItem(ui->tableWidgetSpur->rowCount()-1,5,new QTableWidgetItem(""));//受控
        ui->tableWidgetSpur->setItem(ui->tableWidgetSpur->rowCount()-1,5,new QTableWidgetItem(QueryEquipmentTemplate.value("ConnDesc").toString()));//描述

        if(QueryEquipmentTemplate.value("InterConnect").toString()!="")
        {
            ListInterConnectInfo.append(QString::number(ui->tableWidgetSpur->rowCount()-1)+":"+QueryEquipmentTemplate.value("InterConnect").toString());
        }
        qDebug()<<"跳过端子配置";
        //更新端子配置
//        QSqlQuery QueryTermInfo= QSqlQuery(T_LibDatabase);
//        SqlStr=QString("SELECT * FROM TermInfo WHERE EquipmentTemplate_ID = '"+QueryEquipmentTemplate.value("EquipmentTemplate_ID").toString()+"'");
//        QueryTermInfo.exec(SqlStr);
//        while(QueryTermInfo.next())
//        {
//            ui->tableTerm->setRowCount(ui->tableTerm->rowCount()+1);
//            ui->tableTerm->setItem(ui->tableTerm->rowCount()-1,0,new QTableWidgetItem(QueryEquipmentTemplate.value("SpurDT").toString()));
//            ui->tableTerm->item(ui->tableTerm->rowCount()-1,0)->setData(Qt::UserRole,QueryEquipmentTemplate.value("EquipmentTemplate_ID").toString());
//            ui->tableTerm->setItem(ui->tableTerm->rowCount()-1,1,new QTableWidgetItem(QueryTermInfo.value("TermNum").toString()));
//            ui->tableTerm->setItem(ui->tableTerm->rowCount()-1,2,new QTableWidgetItem(QueryTermInfo.value("TestCost").toString()));
//            ui->tableTerm->setItem(ui->tableTerm->rowCount()-1,3,new QTableWidgetItem(QueryTermInfo.value("TermPicPath").toString()));
//            if(QueryTermInfo.value("TagType").toString()!="")
//            {
//                ui->tableTerm->setItem(ui->tableTerm->rowCount()-1,4,new QTableWidgetItem("是"));
//                ui->tableTerm->item(ui->tableTerm->rowCount()-1,4)->setData(Qt::UserRole,QueryTermInfo.value("TagType").toString()+"|"+QueryTermInfo.value("TagColor").toString()+"|"+QueryTermInfo.value("TagPos").toString()+"|"+QueryTermInfo.value("TagEdge").toString());
//            }
//            else
//                ui->tableTerm->setItem(ui->tableTerm->rowCount()-1,4,new QTableWidgetItem("否"));
//        }
    }
    qDebug()<<"ListInterConnectInfo="<<ListInterConnectInfo;
    for(int i=0;i<ListInterConnectInfo.count();i++)
    {
        QString StrInterConnectInfo=ListInterConnectInfo.at(i).split(":").at(1);
        for(int j=0;j<ui->tableWidgetSpur->rowCount();j++)
        {
            if(StrInterConnectInfo.split(",").contains(ui->tableWidgetSpur->item(j,0)->data(Qt::UserRole).toString()))
            {
                if(ui->tableWidgetSpur->item(ListInterConnectInfo.at(i).split(":").at(0).toInt(),5)->text()!="")
                    ui->tableWidgetSpur->item(ListInterConnectInfo.at(i).split(":").at(0).toInt(),5)->setText(ui->tableWidgetSpur->item(ListInterConnectInfo.at(i).split(":").at(0).toInt(),5)->text()+",");
                ui->tableWidgetSpur->item(ListInterConnectInfo.at(i).split(":").at(0).toInt(),5)->setText(ui->tableWidgetSpur->item(ListInterConnectInfo.at(i).split(":").at(0).toInt(),5)->text()+QString::number(j+1));
            }
        }
    }

    //QsciEditVariable->setText(VariableText);
    if(ui->tableWidgetSpur->rowCount()>0)
    {
        QueryEquipmentTemplate.first();
        ui->tableWidgetSpur->setCurrentItem(ui->tableWidgetSpur->item(0,0));
        QString FunDefine=QueryEquipmentTemplate.value("FunDefine").toString();
        QSqlQuery QueryFunctionDefineClass= QSqlQuery(T_LibDatabase);
        SqlStr=QString("SELECT * FROM FunctionDefineClass WHERE FunctionDefineCode = '"+FunDefine+"'");
        QueryFunctionDefineClass.exec(SqlStr);
        if(QueryFunctionDefineClass.next())
        {
            ui->LbSpurFuncName->setText(QueryFunctionDefineClass.value("FunctionDefineName").toString());
            QString Symbol=QueryFunctionDefineClass.value("DefaultSymbol").toString();
            if(Symbol.contains("SPS_"))  UnitSymbolsView("C:/TBD/SPS/"+Symbol+".dwg","C:/TBD/data/TempImage/"+Symbol+".jpg",ui->LbSpurJpg,true);
            else if(Symbol.contains("ES2_")) UnitSymbolsView("C:/TBD/SYMB2LIB/"+Symbol+".dwg","C:/TBD/data/TempImage/"+Symbol+".jpg",ui->LbSpurJpg,true);
        }
    }
}