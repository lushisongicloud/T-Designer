# 批量自动编写模块

## 架构设计

采用 **Manager-Worker** 模式，职责分离清晰：

```
BatchAutoGenerateManager (主线程)
    ├─ 数据库操作（读取/写入）
    ├─ 队列管理（类别轮询）
    ├─ 线程管理（创建/销毁Worker）
    └─ Log管理（写入结果、恢复进度）
    
SingleEquipmentWorker (工作线程)
    ├─ AI调用（DeepSeek）
    ├─ 端口类型识别
    ├─ T模型生成
    └─ T模型校验（复用DialogUnitManage逻辑）
```

## 核心特性

### 1. 数据流向
- **Manager → Worker**: `EquipmentInputData`（器件信息、端口列表、已有配置）
- **Worker → Manager**: `EquipmentProcessResult`（T模型、端口配置、状态）
- **Worker 不访问数据库**，所有数据由 Manager 准备和保存

### 2. 类别轮询策略
```cpp
// 每个最小类别（Level=2）最多取 10 个器件
// 轮询顺序：类别1第1个 → 类别2第1个 → ... → 类别N第1个 → 类别1第2个 → ...
const int MAX_PER_CATEGORY = 10;
```

### 3. Log格式与恢复
```
[RESULT] equipmentId|code|name|categoryName|status|message

恢复规则：
- success: 跳过
- NoPorts: 跳过
- failed: 重新处理
```

### 4. T模型校验
完全复用 `DialogUnitManage::performTModelValidation()` 的校验逻辑：
- `TModelValidator`: 6项校验（器件名称、常量、端口变量、模型结构、故障模式、SMT语法）
- `SmtSyntaxChecker`: 通过 Z3 进行 SMT-LIB2 语法校验
- **不操作UI**，只返回校验结果

## 数据库操作

### Manager 负责的数据库操作

1. **加载输入数据** (`loadEquipmentInputData`)
   - Equipment表：code, name, description
   - Symb2Term + Symbol + Terminal：端口列表
   - port_config表：已有的端口配置

2. **保存结果** (`saveEquipmentResult`)
   - Equipment.TModel：更新T模型
   - port_config表：更新端口配置（类型、变量、连接宏）

3. **容器管理** (`resolveContainerId`)
   - 查询或创建 container_hierarchy 记录
   - 用于关联 port_config 表

### Worker 不访问数据库
- 所有输入通过 `EquipmentInputData` 结构体提供
- 所有输出通过 `EquipmentProcessResult` 结构体返回

## 使用示例

```cpp
BatchAutoGenerateManager manager(database);

// 连接信号
connect(&manager, &BatchAutoGenerateManager::workerLogMessage, 
        [](int workerId, const QString &msg) {
    qDebug() << QString("[Worker%1] %2").arg(workerId).arg(msg);
});

connect(&manager, &BatchAutoGenerateManager::progressUpdated,
        [](int processed, int total, int success, int failed, int noPorts, int skipped) {
    qDebug() << QString("进度: %1/%2 (成功:%3, 失败:%4, 无端口:%5, 跳过:%6)")
        .arg(processed).arg(total).arg(success).arg(failed).arg(noPorts).arg(skipped);
});

// 开始批量处理
manager.start("batch_log.txt", true, 1);  // 恢复模式，1个线程
```

## 待集成

1. **BatchAutoGenerateDialog**
   - QTabWidget：每个Worker一个Tab页
   - 显示AI输入/输出（自动清理历史）
   - 进度条和统计信息

2. **DialogUnitManage集成**
   - "批量自动编写"按钮调用 BatchAutoGenerateManager
   - 保持单器件"自动编写"功能不变

## 文件清单

- `singleequipmentworker.h/cpp`: Worker类实现
- `batchautogeneratemanager.h/cpp`: Manager类实现
- `README.md`: 本文档

## 关键设计决策

1. **线程安全**：Worker 不访问数据库，避免多线程竞争
2. **校验复用**：与单器件模式保持完全一致的校验逻辑
3. **端口配置返回**：结果中包含AI识别的端口类型
4. **类别轮询**：避免单一类别过度集中
5. **Log恢复**：支持断点续传
